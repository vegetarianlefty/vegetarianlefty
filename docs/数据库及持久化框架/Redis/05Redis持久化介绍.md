### Redis 持久化介绍

Redis持久化是Redis数据库提供的一种数据备份和恢复机制，主要目的是为了防止因Redis服务器故障或重启而导致的数据丢失。Redis提供了两种主要的持久化方式：RDB（Redis Database）持久化和AOF（Append Only File）持久化，以及它们的组合——混合持久化。

###  RDB持久化

**原理**：

- RDB持久化通过创建当前Redis服务器内存数据的快照（Snapshot）并将其保存到磁盘上的二进制文件中，实现数据的持久化。

**触发方式**：

- **手动触发**：通过执行`SAVE`或`BGSAVE`命令。`SAVE`命令会阻塞Redis服务器进程，直到RDB文件创建完毕；而`BGSAVE`命令会创建一个子进程来负责创建RDB文件，父进程则继续处理请求，避免了阻塞。
- **自动触发**：在Redis配置文件中设置`save m n`规则，当在m秒内发生n次写操作时，自动触发`BGSAVE`命令。
- **关闭Redis时触发**：Redis在关闭服务时会自动触发一次RDB持久化。
- **主从同步时触发**：当从节点连接到主节点时，主节点会触发一次RDB持久化，并将生成的RDB文件发送给从节点进行同步。

**优点**：

- 高性能：由于采用子进程进行磁盘操作，主进程无需进行磁盘IO，保证了Redis的高性能。
- 快速恢复：RDB文件包含了某一时刻的完整数据快照，可以快速恢复数据。
- 更小的存储空间：RDB文件经过压缩，占用较小的磁盘空间。

**缺点**：

- 数据丢失：由于RDB持久化是基于时间间隔的，可能存在一定程度的数据丢失。
- 子进程占用内存：在生成RDB文件过程中，子进程会占用和主进程相同的内存空间，可能导致内存不足的问题。

### AOF持久化

**原理**：

- AOF持久化通过记录Redis服务器所执行的写命令来记录数据库状态，并在Redis服务器重启时通过重新执行这些命令来恢复数据。

**配置**：

- 在Redis配置文件中设置`appendonly yes`来启用AOF持久化。
- 配置`appendfsync`选项来设置AOF文件的同步策略，包括`always`（每次写操作都同步）、`everysec`（每秒同步一次）和`no`（由操作系统决定何时同步）。

**优点**：

- 更高的数据安全性：根据同步策略的选择，AOF持久化可以保证较高的数据安全性。
- 更好的容错性：即使AOF文件存在部分损坏，仍可以恢复大部分数据。
- 可读性：AOF文件是文本文件，可以轻松查看和分析。

**缺点**：

- 文件较大：AOF文件通常比RDB文件大，因为它包含了所有写入操作的历史记录。
- 写入开销：AOF记录写操作会导致对磁盘的频繁写入，可能对性能产生一定影响。
- 恢复时间较长：在恢复时，需要逐个重放AOF文件中的写操作，因此恢复时间可能较长。

### 混合持久化

**原理**：

- 混合持久化结合了RDB持久化和AOF持久化的优点。在混合持久化模式下，Redis会首先使用RDB持久化将内存中的数据快照存储到磁盘上，然后再使用AOF持久化将所有新的写操作追加到AOF文件中。
- RDB 镜像做全量持久化，AOF 做增量持久化

**优点**：

- 高数据安全性：结合了AOF持久化的高数据安全性。
- 快速恢复：利用RDB持久化的快速数据恢复速度。
- 提高从节点同步效率：利用RDB文件进行快速同步。

**缺点**：

- 较大的存储空间：需要同时维护RDB文件和AOF文件，可能占用较多的磁盘空间。

**开启持久化**：

设置 aof-use-rdb-preamble 的值为yes ,表示开启，设置为 no 表示禁用

**数据恢复**

在同时开启 RDB 和 AOF 持久化时，重启时只会加载 AOF 文件，不会加载 RDB 文件。如果不存在 AOF 文件，才会加载 RDB 文件

### 禁用持久化

同时关闭 RDB + AOF ，Redis 变成纯缓存模式。

禁用 RDB save ""  ，禁用 AOF appendonly no 

> [!IMPORTANT]
>
> 禁用 RDB 模式下 可以使用命令 save 和 bgsave 生成 RDB 文件
>
> 禁用 AOF 模式下 可以使用命令 bgrewriteaof 生成 AOF 文件


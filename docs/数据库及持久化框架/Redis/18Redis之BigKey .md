### BigKey 介绍

Redis 中的 BigKey 指的是存储在 Redis 数据库中占用空间较大的键，BigKey 的具体表现是 Redis 中的 key 对应的value 很大，占用的 Redis 空间比较大，本质上是大 value 问题。

String类型的value值，最大 512MB，大小超过一定阈值10KB即被认为是 BigKey。

对于Set、List、Hash等类型的 value 值,最多包含**2的32次方-1=4294967295‌**的值，个数超过 5000 就被认为是 BigKey 

### BigKey 产生原因

1. **未正确使用Redis**：在不适用的场景下使用Redis，例如使用String类型的Key存放大体积二进制文件型数据，导致Key的value过大。
2. **业务规划不足**：业务上线前规划设计不足，没有对Key中的成员进行合理的拆分，造成个别Key中的成员数量过多。
3. **无效数据的堆积**：未定期清理无效数据，造成如HASH类型Key中的成员持续不断地增加。
4. **访问量突增**：某些业务场景下，由于访问量突然增加，导致某个Key中的数据量急剧增长，从而形成BigKey。

### BigKey 如何发现

1. **使用Redis的info命令**：查看keyspace部分，观察biggest_key_size的大小。当biggest_key_size过大时，说明存在BigKey。
2. **使用scan命令和debug object命令**：通过SCAN命令迭代Redis中的键，同时利用Redis的DEBUG OBJECT命令查看key对应的value大小。如果超过设定的阈值（如1MB），即判定为BigKey。
3. **使用redis-cli工具的–bigkeys参数**：该参数会扫描Redis中的键并返回所有大小超过指定阈值的BigKey。给出每种数据结构Top 1 bigkey，同时给出每种数据类型的键值个数+平均大小。想查询大于10kb的所有key，--bigkeys参数就无能为力了，需要用到memory usage来计算每个键值的字节数
4. **第三方Redis可视化管理工具**：如Redis Enterprise、Astra等，这些工具提供了BigKey检测功能。
5. **分析Redis日志**：关注slave缓慢或者持久化被block的情况，这可能与BigKey有关。

### BigKey 产生危害

1. **内存使用不均衡**：在Redis Cluster中，BigKey可能导致节点的内存空间使用不均匀，破坏集群的负载均衡。
2. **操作阻塞**：由于Redis的单线程特性，操作BigKey可能会耗费较长的时间，导致Redis被阻塞的可能性增大。
3. **网络拥塞**：获取BigKey时产生的网络流量较大，可能引起网络拥塞问题。
4. **影响系统性能**：BigKey的存在会占用大量的内存和带宽资源，从而影响Redis的整体性能。
5. **迁移困难**：在Redis集群中，迁移bigkey可能会因为大value的原因导致迁移失败或速度较慢，影响Redis服务的稳定性。

### BigKey 处理策略

1. **拆分大键**：将存储在大键中的数据（大value）进行拆分，分成多个小的value进行存储。例如，如果大值是一个大的JSON对象，可以通过使用MSET命令将该键的内容拆分存储到各个实例中；如果大值是一个大的列表（list），可以将其拆分为多个小的列表进行存储。
2. **压缩数据**：可以通过序列化或压缩的方法对value进行压缩，以减小占用的内存空间。但需要注意的是，如果压缩后的value仍然特别大，则需要使用拆分的方法进行解决。
3. **优化数据结构**：根据实际需求选择合适的数据结构来存储数据，以减少bigkey的出现。例如，对于需要存储大量字符串的场景，可以考虑使用哈希表来存储每个字符串及其对应的值。
4. **监控与报警**：通过监控系统监控Redis中的内存占用大小和网络带宽的占用大小，以及固定时间内的内存占用增长率。当超过设定的阈值时，进行报警通知处理。

### BigKey 删除

1. **使用DEL命令**：DEL命令可以删除指定的key，包括BigKey。但需要注意的是，直接删除大key可能会导致Redis阻塞，因此建议在系统低峰期进行删除操作。
2. **逐步删除**：对于特别大的BigKey，可以考虑将其拆分为多个小key进行逐步删除。这样可以避免一次性删除大量数据对Redis性能造成的冲击。
3. **备份数据**：在删除BigKey之前，最好先备份数据，以防误删造成数据丢失。
4. **监控与报警**：在删除BigKey的过程中，应持续监控系统性能和网络带宽的变化情况。一旦发现异常情况，应立即停止删除操作并进行排查。
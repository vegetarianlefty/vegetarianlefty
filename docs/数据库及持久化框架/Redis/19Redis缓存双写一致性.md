### Redis 缓存双写一致性概念

Redis缓存双写一致性是指数据库（如MySQL）中的数据与Redis缓存中的数据保持一致。由于高并发场景的存在，缓存双写一致性通常指的是最终一致性，而非实时一致性。

### Redis 缓存双写一致性更新策略

#### 先更新数据库，再更新缓存

> [!WARNING]
>
> **异常导致不一致**：如果在更新数据库后、更新缓存前出现异常，会导致数据库中的数据已更新，但缓存中的数据还是旧值，造成数据不一致。
>
> **多线程并发问题**：多线程环境下，可能存在一个线程更新了数据库但还未更新缓存时，另一个线程已经读取了旧缓存并尝试更新的情况，这同样会导致数据不一致。

####    先更新缓存，再更新数据库

> [!WARNING]
>
> **业务逻辑问题**：业务上一般把数据库作为底层数据源，因此先更新缓存再更新数据库的做法不太合适。
>
> **多线程并发问题**：与先更新数据库再更新缓存类似，多线程环境下也可能导致数据不一致。

#### 先删除缓存，再更新数据库

> [!WARNING]
>
> **缓存命中旧值**：在删除缓存后、更新数据库前，如果有请求访问该数据，会命中已经删除的缓存（此时缓存为空或返回旧值，取决于缓存的实现），然后查询数据库并更新缓存，如果此时数据库还未更新完毕，就会导致缓存中的数据是旧值。
>
> **脏数据写入缓存**：同样在删除缓存后、更新数据库前，如果有请求访问该数据并查询了数据库（此时数据库还未更新），然后写入缓存，就会导致缓存中的数据是脏数据。

#### 先更新数据库，再删除缓存

> [!WARNING]
>
> **缓存删除失败**：如果更新数据库后删除缓存失败，会导致缓存中的数据一直是旧值。
>
> **多线程并发问题**：虽然比先删除缓存再更新数据库的方案要好一些，但在多线程环境下仍然可能存在数据不一致的问题。例如，一个线程更新了数据库但还未删除缓存时，另一个线程读取了旧缓存并尝试更新（或写入新缓存），就会导致数据不一致。

#### 解决方案

1. **使用消息中间件**：如Canal、RabbitMQ、Kafka等。更新数据库后，将操作信息写入数据库的binlog日志（或其他类型的日志），然后订阅程序提取出所需要的数据和key，尝试删除缓存操作。如果删除失败，可以将这些数据信息发送到消息中间件中，由另一个服务或线程异步处理删除缓存的操作。
2. **延时双删**：在更新数据库后先删除缓存，然后在数据库更新操作完成后（可以是一个事务的提交或者一个异步操作的完成），再延时一段时间（这个时间需要大于其他线程读取数据库并写入缓存的时间）后再次删除缓存。这样可以确保即使有其他线程在第一次删除缓存后、数据库更新前读取了旧值并写入了缓存，也会在延时双删的过程中被清除。但延时双删会增加系统的复杂性和延迟。

### MySql Canal Redis 双写一致性

#### 流程

1. **数据更新**：首先，在MySql数据库中更新数据。
2. **binlog日志记录**：MySql在数据更新后，会将更新操作记录到binlog日志中。
3. **Canal监听binlog**：Canal是一个基于MySql binlog解析的增量订阅&消费组件，它会监听MySql的binlog日志，并解析出其中的数据更新操作。
4. **消息发送**：Canal解析出数据更新操作后，会将这些信息发送到消息中间件（如RabbitMQ、Kafka等）。
5. **Redis缓存更新**：消息中间件将接收到的数据更新操作信息发送给Redis缓存更新服务，该服务根据接收到的信息更新Redis缓存中的数据。

#### 原理

1. **MySql binlog**：MySql的binlog是记录数据库所有更新操作的日志文件，包括INSERT、UPDATE、DELETE等操作。Canal通过解析binlog来获取数据库的更新操作。
2. **Canal解析**：Canal是一个开源项目，它基于Java开发，主要功能是解析MySql的binlog日志，并将解析后的数据以事件的形式发送给消费者。
3. **消息中间件**：Canal将解析后的数据更新操作信息发送到消息中间件，消息中间件负责将这些信息异步地发送给Redis缓存更新服务。
4. **Redis缓存更新**：Redis缓存更新服务接收到消息中间件发送的数据更新操作信息后，根据这些信息更新Redis缓存中的数据，从而确保Redis缓存与MySql数据库中的数据保持一致。

#### 操作步骤

1. **开启MySql binlog**：

   - 在MySql的配置文件（如my.cnf或my.ini）中开启binlog功能，并设置binlog的格式为ROW。
   - 重启MySql服务以应用配置。

   ```
   log-bin=mysql-bin #开启 binlog
   binlog-format=ROW #选择 ROW 模式
   server_id=1    #配置MySQL replaction需要定义，不要和canal的 slaveId重复
   
   ROW模式 除了记录sql语句之外，还会记录每个字段的变化情况，能够清楚的记录每行数据的变化历史，但会占用较多的空间。
   STATEMENT模式只记录了sql语句，但是没有记录上下文信息，在进行数据恢复的时候可能会导致数据的丢失情况；
   MIX模式比较灵活的记录，理论上说当遇到了表结构变更的时候，就会记录为statement模式。当遇到了数据更新或者删除情况下就会变为row模式；
   ```

   

2. **创建Canal用户并授权**：

   - 在MySql中创建一个用于Canal连接的用户，并授予相应的权限。

   ```
   DROP USER IF EXISTS 'canal'@'%';
   CREATE USER 'canal'@'%' IDENTIFIED BY 'canal';  
   GRANT ALL PRIVILEGES ON *.* TO 'canal'@'%' IDENTIFIED BY 'canal';  
   FLUSH PRIVILEGES;
    
   SELECT * FROM mysql.user;
   ```

   

3. **下载并配置Canal**：

   - 从Canal的官方网站下载Canal的发布包。
   - 解压发布包，并根据实际需求配置Canal的实例文件（如instance.properties）。

   ```
   canal.instance.master.address=192.168.1.1:3306 #替换成自己真实 IP
   canal.instance.dbUsername=calal  #用户名
   canal.instance.dbPassword=canll  #密码
   ```

   

4. **启动Canal服务**：

   - 根据Canal的配置文件启动Canal服务。
   - 检查Canal服务的日志以确认服务是否启动成功。

5. **配置消息中间件**：

   - 根据实际需求配置消息中间件（如RabbitMQ、Kafka等），以便Canal将解析后的数据更新操作信息发送到消息中间件。

6. **开发Redis缓存更新服务**：

   - 编写一个服务来监听消息中间件中的消息，并根据消息中的数据更新操作信息更新Redis缓存中的数据。

7. **测试双写一致性**：

   - 在MySql数据库中更新数据，并检查Redis缓存中的数据是否同步更新。
   - 如果数据未能同步更新，则检查Canal、消息中间件和Redis缓存更新服务的配置和日志，以排查问题。

### Canal 工作原理

Canal的工作原理主要基于MySQL数据库的主从复制机制，并对其进行扩展和应用。以下是Canal工作原理的详细解释：

#### MySQL主从复制机制

MySQL的主从复制机制是Canal工作的基础。在这个机制中，主库（Master）会将其数据变更操作记录到二进制日志（binlog）中。从库（Slave）则通过读取和执行这些binlog日志来同步主库的数据变更。

1. **主库（Master）**：
   - 将数据变更操作（如INSERT、UPDATE、DELETE）记录到binlog日志中。
2. **从库（Slave）**：
   - 向主库发送dump协议请求，以获取binlog日志。
   - 将接收到的binlog日志存储到其relay log中。
   - 读取并执行relay log中的事件，以同步主库的数据变更。

#### Canal的工作原理

Canal通过模拟MySQL的从库来与主库进行交互，并解析binlog日志中的数据变更事件。以下是Canal工作原理的详细步骤：

1. **注册为从库**：
   - Canal通过配置与MySQL主库进行交互，并注册为一个从库。
   - 它会像真实的MySQL从库一样，持续监听binlog的变化。
2. **读取binlog**：
   - 当MySQL主库执行数据变更操作后，Canal会读取相应的binlog文件。
   - Canal解析这些binlog日志，捕获具体的变更操作（如插入、更新、删除）。
3. **解析binlog**：
   - Canal解析binlog日志中的事件，将其转换为可消费的数据变更事件。
   - 在解析过程中，Canal会获取对应表的结构信息，以便正确解析变更数据中的字段。
4. **数据推送**：
   - Canal将解析后的数据变更事件以流式数据的形式发送到下游系统（如Kafka、RocketMQ等）。
   - 下游系统可以订阅Canal的解析结果，并进行相应的数据处理操作。

#### Canal的应用场景

Canal的应用场景非常广泛，包括但不限于：

1. **数据同步**：
   - Canal可以将MySQL数据库的变更数据实时同步到其他系统，如数据仓库、搜索引擎、缓存系统等。
   - 这有助于实现数据的实时备份和多系统间的数据一致性。
2. **实时数据分析**：
   - Canal可以将数据库的变更数据实时推送到大数据平台（如Hadoop、Flink等）进行分析和处理。
   - 这有助于企业实现高效的实时数据分析。
3. **事件驱动系统**：
   - Canal可以构建基于数据变更的事件驱动架构。
   - 当数据库中的数据发生变化时，Canal可以触发相应的事件，并通知下游系统进行相应的处理。
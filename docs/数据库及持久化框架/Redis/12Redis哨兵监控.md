### Redis哨兵介绍

Redis哨兵（Sentinel）是Redis的高可用性（High  Availability）解决方案，它由一组运行在特定模式下的Redis服务器进程组成，这些进程监控一个或多个主服务器和多个从服务器。当主服务器进入下线状态时，哨兵可以自动将该主服务器下的某一从服务器升级为主服务器继续提供服务，从而保证Redis的高可用性。

### 原理

哨兵通过发送命令（如PING）来监控Redis服务器（包括主服务器和从服务器）的状态。当哨兵检测到主服务器在一定时间内没有响应时，它会将该主服务器标记为“主观下线”。然后，哨兵会向其他哨兵节点发送消息，询问它们是否也认为该主服务器已经下线。如果足够多的哨兵节点（达到配置中的法定票数quorum）同意该主服务器已经下线，那么该主服务器就会被标记为“客观下线”。

一旦主服务器被标记为客观下线，哨兵节点就会开始执行故障转移流程。首先，它们会选举出一个领导者哨兵节点。然后，这个领导者哨兵节点会选择一个从服务器作为新的主服务器，并向其他从服务器发送命令，让它们切换到新的主服务器。最后，哨兵会更新它们的配置文件和状态信息，以反映这些变化。

### 配置文件

哨兵的配置文件通常命名为`sentinel.conf`，以下是一些常见的配置项：

- `port`：哨兵实例运行的端口。
- `dir`：哨兵实例的工作目录。
- `sentinel monitor`：设置要监控的主服务器信息，包括主服务器的名称、IP地址、端口号和法定票数（quorum）。
- `sentinel auth-pass`：设置连接主服务器和从服务器的密码（如果主服务器和从服务器设置了密码）。
- `sentinel down-after-milliseconds`：指定多少毫秒之后，主节点没有应答哨兵，此时哨兵主观上认为主节点下线。
- `sentinel parallel-syncs`：表示允许并行同步的从服务器个数。
- `sentinel failover-timeout`：故障转移的超时时间。

### 命令

Redis哨兵提供了一些命令来管理和监控Redis集群，以下是一些常用的命令：

- `SENTINEL masters`：列出所有被监控的主服务器。
- `SENTINEL slaves <master-name>`：列出指定主服务器的所有从服务器。
- `SENTINEL get-master-addr-by-name <master-name>`：返回指定主服务器的当前地址和端口号。
- `SENTINEL reset <pattern>`：重置所有匹配给定模式的哨兵配置。
- `SENTINEL failover <master-name>`：手动触发故障转移流程。

### Redis哨兵运行流程

1. **哨兵实例连接建立**：
   - 初始化服务器状态信息并建立与主服务器的网络连接。
   - 服务器会创建一个sentinelState结构体，结构中设置一个master字典（key-value，即master名称-sentinelRedisInstanc）去保留所监视的主服务器信息。
   - 根据给定配置文件，初始化Sentinel主服务器列表（本质上就是初始化sentinelState结构体中的master字典）。
   - 创建主服务器的网络连接，对于每个主服务器会创建2个异步网络连接，分别是命令连接与订阅连接。
2. **监控阶段**：
   - 哨兵节点会定期向Redis主节点和从节点发送PING命令，用于监控节点的状态。
   - 如果主节点在一定时间内没有回复PING命令，哨兵节点会认为主节点可能已经失效。
3. **主观下线阶段**：
   - 当某个哨兵节点检测到主节点失效后，会将该主节点标记为“主观下线”。
   - 主观下线是哨兵节点单方面的判断，不一定代表主节点真的失效。
4. **客观下线阶段**：
   - 哨兵节点之间会相互通信，交换各自对主节点的判断结果。
   - 如果足够多的哨兵节点（达到配置中的法定票数quorum）都认为主节点已经失效，那么该主节点就会被标记为“客观下线”。
5. **通知阶段**：
   - 当被监控的服务器出现问题时，Sentinel会向其他（哨兵间、客户端）发送通知。
6. **选举领导者哨兵阶段**：
   - 在主节点被标记为客观下线后，哨兵节点会进行协商，选举出一个领导者哨兵节点。
   - 选举过程通常使用Raft一致性算法或其他类似的分布式选举算法。
7. **自动故障转移阶段**：
   - 若master宕机，Sentinel会启动自动故障转移流程，包括断开master与slave的连接，选取一个slave作为新的master，将其他slave连接到新的master，并告知客户端新的服务器地址。

### Redis哨兵的选举原理

1. **选举过程**：
   - 选举过程主要分为发现阶段、选举阶段和投票阶段。
   - 在发现阶段，每个哨兵节点都会与其他哨兵节点保持通信，交换信息以发现当前集群中的所有哨兵和节点。
   - 在选举阶段，当某个哨兵节点检测到主节点失效后，会发出选举请求，通知其他哨兵进行主节点的选举。
   - 在投票阶段，每个哨兵节点都会为选举中的候选人进行投票。投票的原则是尽量选择具有最高优先级（如配置文件中的优先级）的哨兵节点作为领导者。
2. **选举规则**：
   - 选举过程中，哨兵节点会使用Raft一致性算法或其他类似的算法来确保选举的一致性和正确性。
   - 领导者哨兵节点需要获得大多数哨兵节点的投票才能成为新的领导者。
   - 如果在选举过程中没有候选人获得超过一半的投票数，那么选举将失败，此时需要等待一段时间后再重新进行选举。
3. **领导者维持地位**：
   - 一旦某个哨兵节点成为领导者后，它会定期发送心跳消息给其他哨兵节点以保持自己的领导者地位。
   - 如果其他哨兵节点长时间没有收到领导者的心跳消息，就会认为领导者失效并触发新一轮的选举过程。

### Redis哨兵选举master的规则

- 选出新的master的规则（在剩余节点健康的前提下）：
  - 优先级：在conf配置文件中，通过replica-priority来设置，数字越小，优先级越高。
  - 偏移量比较：如果优先级一样，则选择偏移量最大的。
  - RunID比较：如果优先级和偏移量都一致，则比较RunID，选择RunID小的。
- Sentinel leader会对选出的新的master执行slave no one操作，将其提升为master节点。
- Sentinel leader向其他slave发送命令，让剩余的slave成为新节点的slave。
- 当老master重新上线后，它会成为新master的slave。

### 优缺点总结

**优点**：

- 提高Redis集群的可用性和稳定性。
- 自动进行故障转移，无需人工干预。
- 支持监控多个主服务器和从服务器。

**缺点**：

- 配置相对复杂，需要了解哨兵的工作原理和配置项。
- 增加系统的复杂度和资源消耗。
- 在进行故障转移时，可能会有一段时间的服务不可用（尽管时间很短）。